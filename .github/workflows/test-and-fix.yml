name: Test and Suggest Fixes

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main ]

env:
  LLM_PROVIDER: ${{ vars.LLM_PROVIDER || 'mock' }}

jobs:
  # ============================================
  # Tests Python
  # ============================================
  test-python:
    runs-on: ubuntu-latest
    outputs:
      test-failed: ${{ steps.pytest.outcome == 'failure' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Python tests
        id: pytest
        continue-on-error: true
        run: |
          set -o pipefail
          cd ${{ github.workspace }}
          pytest tests/python/ -v --tb=long -c config/pytest.ini 2>&1 | tee test-output.txt
          exit ${PIPESTATUS[0]}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-test-results
          path: test-output.txt
          retention-days: 7

  # ============================================
  # Tests JavaScript
  # ============================================
  test-javascript:
    runs-on: ubuntu-latest
    outputs:
      test-failed: ${{ steps.jest.outcome == 'failure' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run JavaScript tests
        id: jest
        continue-on-error: true
        run: |
          npm test 2>&1 | tee test-output.txt
          exit ${PIPESTATUS[0]}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: javascript-test-results
          path: test-output.txt
          retention-days: 7

  # ============================================
  # Tests Java
  # ============================================
  test-java:
    runs-on: ubuntu-latest
    outputs:
      test-failed: ${{ steps.maven.outcome == 'failure' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Java tests
        id: maven
        continue-on-error: true
        run: |
          mvn test -f config/pom.xml 2>&1 | tee test-output.txt
          exit ${PIPESTATUS[0]}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: java-test-results
          path: test-output.txt
          retention-days: 7

  # ============================================
  # Job de suggestion de corrections LLM
  # ============================================
  suggest-fixes:
    runs-on: ubuntu-latest
    needs: [test-python, test-javascript, test-java]
    if: |
      always() && (
        needs.test-python.outputs.test-failed == 'true' ||
        needs.test-javascript.outputs.test-failed == 'true' ||
        needs.test-java.outputs.test-failed == 'true'
      )

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python for LLM script
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install LLM dependencies
        run: |
          pip install requests
          # Installer les dépendances optionnelles selon le provider
          if [ "${{ env.LLM_PROVIDER }}" = "anthropic" ]; then
            pip install anthropic
          elif [ "${{ env.LLM_PROVIDER }}" = "openai" ]; then
            pip install openai
          fi

      - name: Download all test artifacts
        uses: actions/download-artifact@v4
        with:
          path: test-artifacts/

      - name: Analyze failures and suggest fixes
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          OLLAMA_URL: ${{ vars.OLLAMA_URL }}
          OLLAMA_MODEL: ${{ vars.OLLAMA_MODEL }}
        run: |
          python scripts/llm_fix_suggester.py \
            --artifacts-dir test-artifacts/ \
            --contexts-dir contexts/ \
            --src-dir src/ \
            --output-file fix-suggestions.md \
            --provider ${{ env.LLM_PROVIDER }}

      - name: Upload fix suggestions
        uses: actions/upload-artifact@v4
        with:
          name: fix-suggestions
          path: fix-suggestions.md
          retention-days: 30

      - name: Comment on PR with suggestions
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const suggestions = fs.readFileSync('fix-suggestions.md', 'utf8');

            // Tronquer si trop long pour un commentaire GitHub
            const maxLength = 65000;
            const truncatedSuggestions = suggestions.length > maxLength
              ? suggestions.substring(0, maxLength) + '\n\n... (tronqué)'
              : suggestions;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: truncatedSuggestions
            });

      - name: Post suggestions to job summary
        run: |
          echo "## Suggestions de correction LLM" >> $GITHUB_STEP_SUMMARY
          cat fix-suggestions.md >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Résumé final
  # ============================================
  summary:
    runs-on: ubuntu-latest
    needs: [test-python, test-javascript, test-java]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Résumé des tests Secpilot" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Langage | Statut |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python | ${{ needs.test-python.outputs.test-failed == 'true' && '❌ Échec' || '✅ Succès' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| JavaScript | ${{ needs.test-javascript.outputs.test-failed == 'true' && '❌ Échec' || '✅ Succès' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Java | ${{ needs.test-java.outputs.test-failed == 'true' && '❌ Échec' || '✅ Succès' }} |" >> $GITHUB_STEP_SUMMARY
